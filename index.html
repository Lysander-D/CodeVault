<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>CodeVault</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f2f2f7; -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        /* Animations */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .animate-in { animation: fadeIn 0.3s ease-out; }
        .animate-slide-up { animation: slideUp 0.3s ease-out; }
    </style>
    <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@18.2.0",
    "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
    "lucide-react": "https://esm.sh/lucide-react@0.292.0",
    "react-dom/": "https://esm.sh/react-dom@^19.2.4/",
    "react/": "https://esm.sh/react@^19.2.4/"
  }
}
</script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo } from 'react';
        import ReactDOM from 'react-dom/client';
        import { 
            Trash2, History, RotateCcw, CheckCircle2, Settings2, 
            Pencil, Check, ListFilter, Plus, X, ArrowRight, 
            Copy, Circle 
        } from 'lucide-react';

        // --- Utils ---
        const generateId = () => Math.random().toString(36).substring(2, 9);

        const parseCodesFromText = (text, category) => {
            const regex = /[a-zA-Z0-9]{20,60}/g;
            const matches = text.match(regex);
            if (!matches) return [];

            const uniqueMatches = Array.from(new Set(matches));
            const baseTime = Date.now();

            return uniqueMatches.map((code, index) => ({
                id: generateId(),
                value: code,
                prefix: code.substring(0, 4).toUpperCase(),
                category: category,
                isUsed: false,
                createdAt: baseTime + index,
            }));
        };

        const groupCodesByPrefix = (codes) => {
            const groups = {};
            codes.forEach((code) => {
                if (!groups[code.prefix]) groups[code.prefix] = [];
                groups[code.prefix].push(code);
            });
            return Object.keys(groups).sort().map((prefix) => ({
                prefix,
                codes: groups[prefix].sort((a, b) => a.createdAt - b.createdAt),
            }));
        };

        const safeLoad = (key, fallback) => {
            try {
                const item = localStorage.getItem(key);
                return item ? JSON.parse(item) : fallback;
            } catch (e) { return fallback; }
        };

        // --- Components ---

        const Toast = ({ message, isVisible, onClose }) => {
            useEffect(() => {
                if (isVisible) {
                    const timer = setTimeout(onClose, 2000);
                    return () => clearTimeout(timer);
                }
            }, [isVisible, onClose]);

            if (!isVisible) return null;

            return (
                <div className="fixed bottom-8 left-1/2 transform -translate-x-1/2 z-50 animate-slide-up">
                    <div className="bg-slate-800/90 backdrop-blur-md text-white px-4 py-2.5 rounded-full shadow-lg flex items-center gap-2 text-sm font-medium">
                        <div className="bg-green-500 rounded-full p-0.5">
                            <Check size={12} className="text-white" strokeWidth={3} />
                        </div>
                        {message}
                    </div>
                </div>
            );
        };

        const InputSection = ({ onParse, defaultCategory, categories }) => {
            const [isOpen, setIsOpen] = useState(false);
            const [text, setText] = useState('');
            const [selectedCategory, setSelectedCategory] = useState(defaultCategory);

            useEffect(() => {
                if (categories.includes(defaultCategory)) {
                    setSelectedCategory(defaultCategory);
                } else if (categories.length > 0) {
                    setSelectedCategory(categories[0]);
                }
            }, [defaultCategory, categories]);

            const handleParse = () => {
                if (!text.trim()) return;
                onParse(text, selectedCategory);
                setText('');
                setIsOpen(false);
            };

            if (!isOpen) {
                return (
                    <div className="px-4 mb-6">
                        <button
                            onClick={() => setIsOpen(true)}
                            className="w-full bg-white rounded-xl p-4 shadow-sm flex items-center justify-center gap-2 text-blue-600 font-medium active:scale-95 transition-transform"
                        >
                            <Plus size={20} />
                            Add New Codes
                        </button>
                    </div>
                );
            }

            return (
                <div className="px-4 mb-6">
                    <div className="bg-white rounded-xl p-4 shadow-sm space-y-4 animate-in">
                        <div className="flex justify-between items-center">
                            <h3 className="font-semibold text-slate-900 flex items-center gap-2">Import Codes</h3>
                            <button onClick={() => setIsOpen(false)} className="text-slate-400 hover:text-slate-600 p-1 bg-slate-100 rounded-full">
                                <X size={16} />
                            </button>
                        </div>
                        <div>
                            <label className="text-xs font-semibold text-slate-500 uppercase tracking-wider mb-2 block">Select Category</label>
                            <div className="flex flex-wrap gap-2">
                                {categories.map((cat) => (
                                    <button
                                        key={cat}
                                        onClick={() => setSelectedCategory(cat)}
                                        className={`px-3 py-1.5 rounded-full text-sm font-medium transition-all ${
                                            selectedCategory === cat ? 'bg-blue-600 text-white shadow-md' : 'bg-slate-100 text-slate-600'
                                        }`}
                                    >
                                        {cat}
                                    </button>
                                ))}
                            </div>
                        </div>
                        <textarea
                            className="w-full bg-slate-50 rounded-lg p-3 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500/20 placeholder:text-slate-400 resize-none min-h-[120px]"
                            placeholder="Paste text here..."
                            value={text}
                            onChange={(e) => setText(e.target.value)}
                        />
                        <button
                            onClick={handleParse}
                            disabled={!text.trim()}
                            className={`w-full py-3 rounded-lg flex items-center justify-center gap-2 font-semibold transition-all ${
                                text.trim() ? 'bg-blue-600 text-white shadow-md active:scale-[0.98]' : 'bg-slate-100 text-slate-400 cursor-not-allowed'
                            }`}
                        >
                            Extract to {selectedCategory} <ArrowRight size={18} />
                        </button>
                    </div>
                </div>
            );
        };

        const CodeRow = ({ code, onCopy, onToggle, onDelete, isEditing }) => {
            return (
                <div className={`relative flex items-center bg-white pl-4 min-h-[56px] transition-colors group ${code.isUsed ? 'bg-slate-50' : 'active:bg-slate-50'}`}>
                    {isEditing && (
                        <button onClick={() => onDelete(code.id)} className="mr-3 text-red-500 hover:bg-red-50 p-1 rounded-full transition-colors">
                            <div className="w-5 h-5 rounded-full bg-red-500 flex items-center justify-center">
                                <div className="w-2.5 h-0.5 bg-white rounded-full" />
                            </div>
                        </button>
                    )}
                    <div onClick={() => !isEditing && onCopy(code)} className="flex-1 py-3 pr-4 cursor-pointer flex flex-col justify-center overflow-hidden">
                        <span className={`font-mono text-[15px] truncate transition-all duration-300 ${code.isUsed ? 'text-slate-400 line-through decoration-slate-300' : 'text-slate-900 font-medium'}`}>
                            {code.value}
                        </span>
                    </div>
                    <div className="pr-4 pl-2 py-3 border-l border-transparent">
                        <button onClick={(e) => { e.stopPropagation(); onToggle(code.id); }} className={`transition-all duration-200 ${code.isUsed ? 'text-slate-400' : 'text-slate-300 hover:text-blue-500'}`}>
                            {code.isUsed ? <CheckCircle2 size={22} className="fill-slate-100" /> : <Circle size={22} strokeWidth={1.5} />}
                        </button>
                    </div>
                    <div className="absolute bottom-0 right-0 left-4 h-[1px] bg-slate-100 group-last:hidden" />
                </div>
            );
        };

        // --- Main App ---

        const DEFAULT_CATEGORIES = ['Apple', 'Android', 'General', 'Other'];
        const STORAGE_KEY_DATA = 'codevault_v6_final';
        const STORAGE_KEY_CATS = 'codevault_cats_v6_final';

        function App() {
            const [codes, setCodes] = useState(() => safeLoad(STORAGE_KEY_DATA, []));
            const [categories, setCategories] = useState(() => safeLoad(STORAGE_KEY_CATS, DEFAULT_CATEGORIES));
            const [activeTab, setActiveTab] = useState(() => {
                const loaded = safeLoad(STORAGE_KEY_CATS, DEFAULT_CATEGORIES);
                return loaded[0] || 'Apple';
            });
            
            const [isEditingList, setIsEditingList] = useState(false);
            const [isEditingTabs, setIsEditingTabs] = useState(false);
            const [editingTabName, setEditingTabName] = useState(null);
            const [editInputVal, setEditInputVal] = useState('');
            const [toast, setToast] = useState({ visible: false, message: '' });

            const syncAll = (newCodes, newCats) => {
                setCodes(newCodes);
                localStorage.setItem(STORAGE_KEY_DATA, JSON.stringify(newCodes));
                if (newCats) {
                    setCategories(newCats);
                    localStorage.setItem(STORAGE_KEY_CATS, JSON.stringify(newCats));
                }
            };

            const currentCodes = useMemo(() => {
                return codes
                    .filter(c => c.category === activeTab)
                    .sort((a, b) => (a.createdAt || 0) - (b.createdAt || 0));
            }, [codes, activeTab]);

            const groupedCurrentCodes = useMemo(() => groupCodesByPrefix(currentCodes), [currentCodes]);

            const tabStats = useMemo(() => {
                const stats = {};
                categories.forEach(cat => {
                    const catCodes = codes.filter(c => c.category === cat);
                    stats[cat] = {
                        total: catCodes.length,
                        unused: catCodes.filter(c => !c.isUsed).length
                    };
                });
                return stats;
            }, [codes, categories]);

            const showToast = (message) => setToast({ visible: true, message });

            const handleParse = (text, category) => {
                const parsed = parseCodesFromText(text, category);
                if (parsed.length === 0) return showToast('No valid codes found');
                const existingValues = new Set(codes.map(c => c.value));
                const newItems = parsed.filter(c => !existingValues.has(c.value));
                if (newItems.length === 0) return showToast('Codes already exist');
                
                syncAll([...codes, ...newItems]);
                setActiveTab(category);
                showToast(`Added ${newItems.length} codes`);
            };

            const handleToggle = (id) => {
                const newDb = codes.map(c => c.id === id ? { ...c, isUsed: !c.isUsed } : c);
                syncAll(newDb);
            };

            const handleCopy = async (code) => {
                try {
                    await navigator.clipboard.writeText(code.value);
                    if (!code.isUsed) {
                        const newDb = codes.map(c => c.id === code.id ? { ...c, isUsed: true } : c);
                        syncAll(newDb);
                    }
                    showToast('Copied & Marked');
                } catch (err) { showToast('Copy Failed'); }
            };

            const handleClearUsedInTab = () => {
                const usedInCurrentTab = codes.filter(c => c.category === activeTab && c.isUsed);
                if (usedInCurrentTab.length === 0) return showToast('No used codes to clear');
                if (window.confirm(`Delete ${usedInCurrentTab.length} used codes from ${activeTab}?`)) {
                    const remainingCodes = codes.filter(c => !(c.category === activeTab && c.isUsed));
                    syncAll(remainingCodes);
                    showToast(`Cleared ${usedInCurrentTab.length} items`);
                }
            };

            const handleResetAll = () => {
                if (window.confirm('WARNING: This will delete EVERYTHING. Are you sure?')) {
                    localStorage.clear();
                    window.location.reload();
                }
            };

            const startRenaming = (cat) => { setEditingTabName(cat); setEditInputVal(cat); };
            const finishRenaming = () => {
                if (!editingTabName) return;
                const oldName = editingTabName;
                const newName = editInputVal.trim();
                if (!newName || newName === oldName) { setEditingTabName(null); return; }
                if (categories.includes(newName)) return showToast('Name already exists');

                const updatedCats = categories.map(c => c === oldName ? newName : c);
                const updatedCodes = codes.map(c => c.category === oldName ? { ...c, category: newName } : c);
                if (activeTab === oldName) setActiveTab(newName);
                syncAll(updatedCodes, updatedCats);
                setEditingTabName(null);
            };

            return (
                <div className="min-h-screen pb-32 bg-[#f2f2f7] font-sans">
                    <header className="sticky top-0 z-30 bg-[#f2f2f7]/90 backdrop-blur-md border-b border-slate-200/80 px-4 h-14 flex items-center justify-between">
                        <h1 className="text-lg font-bold text-slate-900 flex items-center gap-2">
                            <div className="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white text-[10px] shadow-sm">CV</div>
                            CodeVault
                        </h1>
                        {currentCodes.length > 0 && !isEditingTabs && (
                            <button onClick={() => setIsEditingList(!isEditingList)} className="text-blue-600 font-semibold text-sm">
                                {isEditingList ? 'Done' : 'Edit'}
                            </button>
                        )}
                    </header>

                    <main className="max-w-2xl mx-auto pt-4">
                        <InputSection onParse={handleParse} defaultCategory={activeTab} categories={categories} />

                        <div className="px-4 mb-4">
                            <div className="flex items-center gap-2">
                                <div className="flex-1 overflow-x-auto no-scrollbar bg-slate-200/80 p-1 rounded-xl flex gap-1">
                                    {categories.map(cat => {
                                        const stats = tabStats[cat] || { total: 0, unused: 0 };
                                        const isActive = activeTab === cat;
                                        return (
                                            <button key={cat} onClick={() => { if(isEditingTabs) startRenaming(cat); else setActiveTab(cat); }}
                                                className={`flex-1 min-w-[100px] py-2 rounded-lg text-xs font-bold transition-all ${isActive ? 'bg-white text-black shadow-sm' : 'text-slate-500'}`}>
                                                {editingTabName === cat ? (
                                                    <input autoFocus value={editInputVal} onChange={e => setEditInputVal(e.target.value)} onBlur={finishRenaming} className="w-full text-center outline-none bg-transparent text-blue-600" />
                                                ) : (
                                                    <div className="flex flex-col">
                                                        <span>{cat}</span>
                                                        <span className={`text-[9px] ${stats.unused > 0 ? 'text-blue-600' : 'opacity-50'}`}>({stats.unused}/{stats.total})</span>
                                                    </div>
                                                )}
                                            </button>
                                        );
                                    })}
                                </div>
                                <button onClick={() => setIsEditingTabs(!isEditingTabs)} className={`p-2 rounded-xl bg-white shadow-sm ${isEditingTabs ? 'text-blue-600' : 'text-slate-400'}`}>
                                    <Settings2 size={20} />
                                </button>
                            </div>
                        </div>

                        <div className="px-4 space-y-4">
                            {currentCodes.length === 0 ? (
                                <div className="text-center py-20 opacity-30 font-bold">EMPTY IN {activeTab}</div>
                            ) : (
                                groupedCurrentCodes.map(group => (
                                    <div key={group.prefix} className="space-y-1">
                                        <div className="text-[10px] font-bold text-slate-400 ml-1 uppercase">{group.prefix}</div>
                                        <div className="bg-white rounded-xl overflow-hidden shadow-sm divide-y divide-slate-100">
                                            {group.codes.map(code => (
                                                <CodeRow key={code.id} code={code} onCopy={handleCopy} onToggle={handleToggle} onDelete={id => syncAll(codes.filter(c => c.id !== id))} isEditing={isEditingList} />
                                            ))}
                                        </div>
                                    </div>
                                ))
                            )}

                            <div className="grid grid-cols-2 gap-3 pt-6">
                                <button onClick={handleClearUsedInTab} className="bg-white p-4 rounded-2xl shadow-sm flex flex-col items-center active:bg-slate-50 transition-colors">
                                    <CheckCircle2 className="text-blue-600 mb-1" size={24} />
                                    <span className="text-xs font-bold text-slate-700">Clear Used</span>
                                    <span className="text-[10px] text-slate-400">{activeTab}</span>
                                </button>
                                <button onClick={handleResetAll} className="bg-white p-4 rounded-2xl shadow-sm flex flex-col items-center active:bg-red-50 transition-colors">
                                    <RotateCcw className="text-red-500 mb-1" size={24} />
                                    <span className="text-xs font-bold text-red-600">Factory Reset</span>
                                    <span className="text-[10px] text-red-300">All Data</span>
                                </button>
                            </div>
                        </div>
                    </main>
                    <Toast message={toast.message} isVisible={toast.visible} onClose={() => setToast({ ...toast, visible: false })} />
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>